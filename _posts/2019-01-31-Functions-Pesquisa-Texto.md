---
layout: post
title:  "Firebase Cloud Functionsâ€Šâ€”â€ŠPesquisa de Texto na Base de dados"
date:   2019-01-31 05:00:00 +0200
categories: firebase
---
O artigo original pode ser encontrado no [Medium](https://medium.com/android-dev-moz/fcf-search-7fd744b60dee).
<section name="43f2" class="section section--body section--first"><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h4 name="0023" id="0023" class="graf graf--h4 graf-after--h3 graf--subtitle">Algolia &amp; ElasticSearch vsÂ Tocha</h4><p name="a669" id="a669" class="graf graf--p graf-after--h4"><strong class="markup--strong markup--p-strong">Este artigo Ã© parte da sÃ©rie Firebase Cloud Functions:</strong></p><ol class="postList"><li name="aebc" id="aebc" class="graf graf--li graf-after--p"><a href="https://medium.com/@rosariopfernandes/firebase-cloud-functions-f6ed3787fa8d" data-href="https://medium.com/@rosariopfernandes/firebase-cloud-functions-f6ed3787fa8d" class="markup--anchor markup--li-anchor" target="_blank">O que Ã© Firebase Cloud Functions?</a></li><li name="192b" id="192b" class="graf graf--li graf-after--li"><a href="https://medium.com/@rosariopfernandes/fcf-comecar-32c984dbc12" data-href="https://medium.com/@rosariopfernandes/fcf-comecar-32c984dbc12" class="markup--anchor markup--li-anchor" target="_blank">Firebase Cloud Functionsâ€Šâ€”â€ŠComo comeÃ§ar?</a></li><li name="8f70" id="8f70" class="graf graf--li graf-after--li"><a href="https://medium.com/@rosariopfernandes/fcf-fcm-d5828e7eab94" data-href="https://medium.com/@rosariopfernandes/fcf-fcm-d5828e7eab94" class="markup--anchor markup--li-anchor" target="_blank">Firebase Cloud Functions + Cloud Messaging</a></li><li name="852d" id="852d" class="graf graf--li graf-after--li"><a href="https://medium.com/@rosariopfernandes/fcf-mantain-c95c520089d9" data-href="https://medium.com/@rosariopfernandes/fcf-mantain-c95c520089d9" class="markup--anchor markup--li-anchor" target="_blank">Firebase Cloud Functionsâ€Šâ€”â€ŠLimpeza e ManutenÃ§Ã£o da Realtime Database</a></li><li name="d106" id="d106" class="graf graf--li graf-after--li"><a href="/firebase/2018/02/19/Functions-Callable.html" data-href="https://medium.com/@rosariopfernandes/48d503a6cd24" class="markup--anchor markup--li-anchor" target="_blank">Firebase Cloud Functionsâ€Šâ€”â€ŠChame uma funÃ§Ã£o na sua app</a></li><li name="d88e" id="d88e" class="graf graf--li graf-after--li graf--trailing">Firebase Cloud Functionsâ€Šâ€”â€ŠPesquisa de Texto na Base de Dados</li></ol></div></div></section><section name="11ef" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="1d83" id="1d83" class="graf graf--p graf--leading">Uma das funcionalidades mais requisitadas Ã  equipe do Firebase Ã© a possibilidade de fazer a clÃ¡ssica â€œPesquisa de Textoâ€ na Realtime Database ou no Cloud Firestore. Para quem vem do SQL, esta Ã© a famosa operaÃ§Ã£o <code class="markup--code markup--p-code">LIKE</code>, que Ã© bastante utilizada em caixas/campos de procura de texto.</p><p name="c0b8" id="c0b8" class="graf graf--p graf-after--p">Na altura em que a Realtime Database era o Ãºnico serviÃ§o de Base de Dados do Firebase, esta funcionalidade jÃ¡ era pedida por desenvolvedores e, como soluÃ§Ã£o, o Firebase trouxe a <a href="https://github.com/FirebaseExtended/flashlight" data-href="https://github.com/FirebaseExtended/flashlight" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">Flashlight</strong></a>â€Šâ€”â€Šuma biblioteca que conecta-se Ã  plataforma ElasticSearch para permitir estas pesquisas.</p><p name="342b" id="342b" class="graf graf--p graf-after--p">Para quem nÃ£o conhece, <a href="https://www.elastic.co/products/elasticsearch" data-href="https://www.elastic.co/products/elasticsearch" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">ElasticSearch</a> Ã© uma plataforma que faz a indexaÃ§Ã£o de dados para futuras pesquisas. Ela funciona da seguinte forma: VocÃª envia para a plataforma os dados que precisam ser indexados (neste caso, o nÃ³ da Realtime Database em que pretende pesquisar) e para fazer a pesquisa vocÃª envia uma requisiÃ§Ã£o HTTP para a REST API deles e a API retorna os resultados da sua pesquisa.</p><p name="4312" id="4312" class="graf graf--p graf-after--p">Quando surgiu o Cloud Firestore, vimos vÃ¡rias funcionalidades de consulta(querying) de dados sendo adicionadas, que podemos dizer que sÃ£o melhorias quando comparadas com as funcionalidades de consulta que existiam na Realtime Database. Mas infelizmente, ainda nada sobre a Pesquisa de Texto. Como soluÃ§Ã£o, o Firebase criou um <a href="https://firebase.google.com/docs/firestore/solutions/search?hl=pt-pt" data-href="https://firebase.google.com/docs/firestore/solutions/search?hl=pt-pt" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Tutorial de como conectar Firestore Ã  Algolia para Pesquisa de Texto</a>. <a href="https://www.algolia.com/" data-href="https://www.algolia.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Algolia</a> Ã© outra plataforma de indexaÃ§Ã£o muito similar ao ElasticSearch, inclusive funcionam da mesma maneira.</p><p name="2a5a" id="2a5a" class="graf graf--p graf-after--p">Apesar destas plataformas parecerem ser a soluÃ§Ã£o perfeita, existem alguns aspetos a ter em conta:</p><ol class="postList"><li name="4d7c" id="4d7c" class="graf graf--li graf-after--p">VocÃª estÃ¡ partilhando os seus dados com plataformas de terceiros;</li><li name="6b2c" id="6b2c" class="graf graf--li graf-after--li">Ã‰ recomendado fazer as requisiÃ§Ãµes em um servidor, pois estas plataformas dÃ£o-lhe uma Chave (API KEY) que nÃ£o deverÃ¡ ser exposta em aplicaÃ§Ãµes cliente.</li></ol><p name="745d" id="745d" class="graf graf--p graf-after--li">Segundo o <a href="https://firebase.google.com/docs/firestore/solutions/search?hl=pt-pt" data-href="https://firebase.google.com/docs/firestore/solutions/search?hl=pt-pt" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">tutorial do Firebase</a>, o 2Âº ponto que mencionei nÃ£o serÃ¡ um problema, afinal de contas, existe o Firebase Cloud Functions que permite executar algumas funÃ§Ãµes no lado do servidor (server-side).</p><p name="017c" id="017c" class="graf graf--p graf-after--p">Apesar da combinaÃ§Ã£o â€œCloud Functions +Algolia/ElasticSearchâ€ ser perfeita, ela tem um inconveniente: quando estiver a utilizar o plano grÃ¡tis (Spark Plan) do Firebase, as Cloud Functions nÃ£o podem enviar requisiÃ§Ãµes para endereÃ§os externos (que nÃ£o fazem parte da Google). SÃ³ quem estiver a utilizar um dos planos pagos (Flame ou Blaze Plan) Ã© que tem a permissÃ£o para fazer isso.<br>Isto implica que caso vocÃª queira enviar requisiÃ§Ãµes Ã  Algolia/ElasticSearch atravÃ©s das Cloud Functions, vocÃª precisa adicionar o seu cartÃ£o de crÃ©dito e optar por um dos planos pagos.</p><p name="f80d" id="f80d" class="graf graf--p graf-after--p">Adicionar um cartÃ£o de crÃ©dito nÃ£o deve ser problema para alguns, atÃ© porque mesmo depois de adicionar, eles nÃ£o irÃ£o cobrar-lhe nada atÃ© que atinja um certo limite (conheÃ§a os limites na <a href="https://firebase.google.com/pricing/" data-href="https://firebase.google.com/pricing/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">tabela de preÃ§os</a>) e este limite Ã© alto o suficiente para que uma aplicaÃ§Ã£o de pequena escala nÃ£o o atinja em pouco tempo.</p><p name="31c8" id="31c8" class="graf graf--p graf-after--p">Mas por outro lado, existem desenvolvedores que nÃ£o pretendem utilizar estes planos, mesmo porque provavelmente nÃ£o utilizarÃ£o nem metade das funcionalidades oferecidas ou porque estÃ£o a desenvolver apenas um protÃ³tipo. Foi a pensar nestes desenvolvedores que decidi criar uma forma de fazer a Pesquisa de Texto no plano grÃ¡tis (Spark).</p><h3 name="a5b5" id="a5b5" class="graf graf--h3 graf-after--p">Tochaâ€Šâ€”â€ŠPesquisas de Texto no PlanoÂ Spark</h3><p name="0a60" id="0a60" class="graf graf--p graf-after--h3"><a href="https://github.com/rosariopfernandes/Tocha" data-href="https://github.com/rosariopfernandes/Tocha" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Tocha</a> Ã© uma biblioteca Open Source, por mim desenvolvida, que permite fazer pesquisas de texto no Cloud Firestore e na Realtime Database mesmo que o seu projeto ainda esteja no plano grÃ¡tis (Spark). Ã‰ ideal para protÃ³tipos ou pequenas aplicaÃ§Ãµes Android/iOS.Â <br>E tal como as outras soluÃ§Ãµes de pesquisa de texto para o Firebase, esta biblioteca funciona atravÃ©s de Cloud Functions.</p><h4 name="01dc" id="01dc" class="graf graf--h4 graf-after--p">Como comeÃ§ar</h4><p name="aa0e" id="aa0e" class="graf graf--p graf-after--h4">Vou assumir que vocÃª jÃ¡ sabe criar e fazer o deploy de Cloud Functions. Caso nÃ£o, leia o <a href="https://medium.com/@rosariopfernandes/fcf-comecar-32c984dbc12" data-href="https://medium.com/@rosariopfernandes/fcf-comecar-32c984dbc12" class="markup--anchor markup--p-anchor" target="_blank">segundo artigo</a> desta sÃ©rie.</p><ol class="postList"><li name="2454" id="2454" class="graf graf--li graf-after--p">No directÃ³rio functions do seu projeto Firebase, abra o ficheiro <em class="markup--em markup--li-em">package.json</em> e certifique-se que a sua cloud function estÃ¡ a utilizar o NodeJS na versÃ£o 8:</li></ol><pre name="0ea3" id="0ea3" class="graf graf--pre graf-after--li">{<br>  // ... name, description, dependencies, etc<br>  <strong class="markup--strong markup--pre-strong">&quot;engines&quot;</strong>: {<br>    <strong class="markup--strong markup--pre-strong">&quot;node&quot;</strong>: <strong class="markup--strong markup--pre-strong">&quot;8&quot;</strong><br>  }<br>}</pre><p name="12dd" id="12dd" class="graf graf--p graf-after--pre">2. Instale o Tocha, abrindo a terminal e utilizando o comando:</p><pre name="5fd9" id="5fd9" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">npm install tocha</strong></pre><p name="5eba" id="5eba" class="graf graf--p graf-after--pre">3. Por fim, abra o ficheiro <code class="markup--code markup--p-code">index.js</code> do directÃ³rio <code class="markup--code markup--p-code">functions</code> e importe a(s) funcionalidade(s) do Tocha que vocÃª precisa:</p><pre name="2398" id="2398" class="graf graf--pre graf-after--p">const functions = require(&#39;firebase-functions&#39;);</pre><pre name="3bed" id="3bed" class="graf graf--pre graf-after--pre">// ... vocÃª pode importar mais bibliotecas aqui ...</pre><pre name="818a" id="818a" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">const tocha = require(&#39;tocha&#39;);</strong><br><br>// Para importar Pesquisa de texto no Cloud Firestore:<br><strong class="markup--strong markup--pre-strong">exports.searchFirestore = tocha.searchFirestore;</strong><br><br>// Para importar Pesquisa de texto na Realtime Database:<br><strong class="markup--strong markup--pre-strong">exports.searchRTDB = tocha.searchRTDB;</strong><br><br>// ... vocÃª pode declarar mais funÃ§Ãµes aqui ...</pre><p name="0c06" id="0c06" class="graf graf--p graf-after--pre">E pronto. Agora sÃ³ basta fazer o deploy das novas funÃ§Ãµes:</p><pre name="1992" id="1992" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">firebase deploy --only functions</strong></pre><h4 name="bc19" id="bc19" class="graf graf--h4 graf-after--pre">Vamos Experimentar</h4><p name="a0d7" id="a0d7" class="graf graf--p graf-after--h4">Suponhamos que temos uma collection no Cloud Firestore que armazena tarefas para uma app de organizaÃ§Ã£o de tarefas. Vamos chamar esta collection de â€œtarefasâ€:</p><figure name="c0c7" id="c0c7" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 568px; max-height: 233px;"><div class="aspectRatioPlaceholder-fill"></div><img class="graf-image" data-image-id="1*OGS3nzYAVva2qT4JRuSxzg.png" data-width="568" data-height="233" src="https://cdn-images-1.medium.com/max/800/1*OGS3nzYAVva2qT4JRuSxzg.png"></div><figcaption class="imageCaption">A collection tarefas e um dos documentos que elaÂ contem.</figcaption></figure><p name="af71" id="af71" class="graf graf--p graf-after--figure">Como vemos na imagem, a collection tem apenas 2 documentos, mas vamos supor que jÃ¡ tenhamos armazenado centenas de tarefas e jÃ¡ nÃ£o nos lembramos Ã  quem tÃ­nhamos de ligar para felicitar.<br>Vamos entÃ£o utilizar o Tocha para pesquisar por tarefas que tenham a palavra â€œLigarâ€ no tÃ­tulo. Para isso, temos de criar uma nova collection com o nome â€œtocha_searchesâ€. Nesta collection vamos adicionar o seguinte documento:</p><pre name="be88" id="be88" class="graf graf--pre graf-after--p">{<br>  &quot;collectionName&quot;: &quot;tarefas&quot;, // collection que vamos pesquisar<br>  &quot;fields&quot;: [&quot;titulo&quot;], // campo(s) a pesquisar<br>  &quot;query&quot;: &quot;Ligar*&quot; // texto a ser encontrado<br>}</pre><p name="0dfe" id="0dfe" class="graf graf--p graf-after--pre">Ao adicionar este documento, a nossa Cloud Function serÃ¡ invocada e se estiver tudo correto, ela irÃ¡ adicionar um campo <code class="markup--code markup--p-code">response</code> ao nosso documento contendo:</p><ul class="postList"><li name="fc25" id="fc25" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code"><strong class="markup--strong markup--li-strong">isSuccessful</strong></code><strong class="markup--strong markup--li-strong"> </strong>(boolean)â€Šâ€”â€Šeste campo terÃ¡ o valor <code class="markup--code markup--li-code">true</code> se a nossa pesquisa for bem sucedida ou <code class="markup--code markup--li-code">false</code> caso contrÃ¡rio.</li><li name="2ad9" id="2ad9" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code"><strong class="markup--strong markup--li-strong">result</strong></code><strong class="markup--strong markup--li-strong">â€Š</strong>â€”â€Šse a pesquisa for bem sucedida, este campo serÃ¡ um array contendo as tarefas que foram encontradas como resultado da pesquisa. <strong class="markup--strong markup--li-strong">Nota:</strong> Se ocorrer algum erro e <code class="markup--code markup--li-code">isSuccessful</code> for <code class="markup--code markup--li-code">false</code>, o campo result nÃ£o existirÃ¡.</li><li name="b1bb" id="b1bb" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code"><strong class="markup--strong markup--li-strong">errorMessage</strong></code>â€Šâ€”â€ŠsÃ³ existe se tiver ocorrido algum erro e o valor do campo Ã© uma String explicando a causa do erro.</li></ul><p name="64a1" id="64a1" class="graf graf--p graf-after--li">EntÃ£o a nossa resposta ficarÃ¡ algo como:</p><figure name="8876" id="8876" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 462px; max-height: 305px;"><div class="aspectRatioPlaceholder-fill"></div><img class="graf-image" data-image-id="1*_DXBKv3evYr_57PchGgKgg.png" data-width="462" data-height="305" src="https://cdn-images-1.medium.com/max/800/1*_DXBKv3evYr_57PchGgKgg.png"></div></figure><p name="055a" id="055a" class="graf graf--p graf-after--figure">Num cenÃ¡rio real, sÃ³ terÃ­amos de ler o valor deste campo <code class="markup--code markup--p-code">result</code> e mostrÃ¡-lo na UI da nossa aplicaÃ§Ã£o Android/iOS. E pronto, pesquisa implementada com sucesso.</p><h4 name="2443" id="2443" class="graf graf--h4 graf-after--p">LimitaÃ§Ãµes</h4><p name="cd19" id="cd19" class="graf graf--p graf-after--h4">Tocha ainda Ã© um projeto em desenvolvimento e possui algumas limitaÃ§Ãµes:</p><ol class="postList"><li name="aff6" id="aff6" class="graf graf--li graf-after--p">Firestore/RTDB Security Rules nÃ£o se aplicam na pesquisa. Isto significa que todas pesquisas realizadas assumem que o utilizador autenticado Ã© administrador e tem acesso Ã  toda base de dados.</li><li name="582b" id="582b" class="graf graf--li graf-after--li">Ainda nÃ£o existe um SDK client-side para executar a pesquisa, mas jÃ¡ comecei a desenvolver um para android(<a href="https://github.com/rosariopfernandes/tocha-android" data-href="https://github.com/rosariopfernandes/tocha-android" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">tocha-android</a>).</li></ol><p name="4015" id="4015" class="graf graf--p graf-after--li">Vale lembrar que Ã© um projeto Open Source, entÃ£o vocÃª tambÃ©m Ã© convidado Ã  contribuir ğŸ™‚ O cÃ³digo-fonte e mais informaÃ§Ãµes podem ser encontrados no GitHub:</p><a href="https://github.com/rosariopfernandes/Tocha" target="_blank">rosariopfernandes/Tocha</a><p name="cf39" id="cf39" class="graf graf--p graf-after--mixtapeEmbed graf--trailing">Espero que esta biblioteca ajude-o no desenvolvimento de protÃ³tipos e/ou pequenas aplicaÃ§Ãµes mÃ³veis com pesquisa de texto no Firebase. ğŸ™‚</p></div></div></section><section name="2604" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="a6c2" id="a6c2" class="graf graf--p graf--leading graf--trailing">Caso tenha alguma dÃºvida ou sugestÃ£o, deixe abaixo nos comentÃ¡rios. Se vocÃª estiver tentando usar a Tocha e teve algum problema, <a href="https://github.com/rosariopfernandes/Tocha/issues/new" data-href="https://github.com/rosariopfernandes/Tocha/issues/new" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">abra um issue</a> no GitHub explicando o que vocÃª fez e qual foi o erro que teve.</p></div></div></section>
